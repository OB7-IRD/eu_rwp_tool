---
title: "maintain_eumap_table_2_1_linkage_2024"
author: "Kirsten Birch HÃ¥kansson, DTU Aqua"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

library(stringr)
library(dplyr)
library(icesVocab)
library(worrms)

knitr::opts_chunk$set(echo = T)

path <- "../inst/"

linkage_file_name_in <- "eumap_table_2_1_linkage_version_2022_v2.4"
linkage_file_name_out <- "eumap_table_2_1_linkage_version_2024_v1.3"

```

```{r, include = F}
# Load linkage file

linkage <- read.csv(paste0(path, linkage_file_name_in, ".csv"), sep = ";", header = T)

names(linkage)

linkage$include_in_table_2.1 <- "yes"
linkage$comments_dev <- ""

# Load classification

SpecWoRMS_with_classi <- readRDS(paste0(path, "SpecWoRMS_with_classifcation.rds"))
```

# Linkage

## Corrections

```{r}

# Wrong area coding in the line below, area 27.9.c is not an area. it should be Union waters of 8 and 9 (SRX/89-C.): 
# 283	North-East Atlantic	All skates and rays	Rajidae	ICES	NA	SRX	########	89-C.	8, 9c	27_8,27_9_C	Extra row and FIDES code stands for rays not elsewhere reported

linkage$area[linkage$region == "North-East Atlantic" &
               linkage$latin_name == "Rajidae" &
               linkage$fides_area == "89-C."] <- "8, 9"
linkage$area_bis[linkage$region == "North-East Atlantic" &
               linkage$latin_name == "Rajidae" &
               linkage$fides_area == "89-C."] <- "27_8,27_9"
linkage$comments_dev[linkage$region == "North-East Atlantic" &
               linkage$latin_name == "Rajidae" &
               linkage$fides_area == "89-C."] <- "area corrected by Kirsten"

# Wrong area coding in the line below, area 27.6.a is wrong and already present in another stock. it should be 27.7.a: 
# North-East Atlantic Whiting Merlangius merlangus ICES NA WHG 126438 07A. 7a 27_6_A

linkage$area_bis[linkage$region == "North-East Atlantic" &
               linkage$latin_name == "Merlangius merlangus" &
               linkage$fides_area == "07A."] <- "27_7_A"
linkage$comments_dev[linkage$region == "North-East Atlantic" &
               linkage$latin_name == "Merlangius merlangus" &
               linkage$fides_area == "07A."] <- "area corrected by Kirsten"

# Duplicated row for Lepidorhombus whiffiagonis in North-East Atlantic. One of them should have been an extra row for Lepidorhombus spp.

linkage <- subset(linkage, !(x3a_code == "LEZ" & region == "North-East Atlantic" & area == "8c, 9a"))
```

```{r}
algae <- data.frame(
  region = NA,
  spp_name = "Algae",
  latin_name = "Chromista",
  rfmo = NA,
  rfmo_stock_id = NA,
  x3a_code = NA,
  worms_aphia_id = 126417,
  fides_area = NA,
  area = NA,
  area_bis = "27",
  area_rdb = NA,
  tac_area_description = NA,
  comments = "Algea",
  latin_name_join =  NA,
  include_in_table_2.1 = "no",
  comments_dev = NA
)

capros <- data.frame(
  region = NA,
  spp_name = "Caproidae",
  latin_name = "Caproidae",
  rfmo = NA,
  rfmo_stock_id = NA,
  x3a_code = NA,
  worms_aphia_id = 125613,
  fides_area = NA,
  area = NA,
  area_bis = "27_6,27_7,27_8",
  area_rdb = NA,
  tac_area_description = NA,
  comments = "Known issue: wrong species level",
  latin_name_join =  "Caproidae",
  include_in_table_2.1 = "no",
  comments_dev = NA
)

trachurus <- data.frame(
  region = NA,
  spp_name = "Trachurus",
  latin_name = "Trachurus",
  rfmo = NA,
  rfmo_stock_id = NA,
  x3a_code = NA,
  worms_aphia_id = NA,
  fides_area = NA,
  area = NA,
  area_bis = "27_2_A,27_4_B,27_4_C,27_7_D,27_8,27_9,27_10,27_4_A,27_5_B,27_6_A,27_7_A,27_7_B,27_7_C,27_7_E,27_7_F,27_7_G,27_7_H,27_7_J,27_7_K,27_8",
  area_rdb = NA,
  tac_area_description = NA,
  comments = "Known issue: wrong species level",
  latin_name_join =  "Trachurus",
  include_in_table_2.1 = "no",
  comments_dev = NA
)

coregonus <- data.frame(
  region = NA,
  spp_name = "Coregonus",
  latin_name = "Coregonus",
  rfmo = NA,
  rfmo_stock_id = NA,
  x3a_code = NA,
  worms_aphia_id = NA,
  fides_area = NA,
  area = NA,
  area_bis = "27_3_B,27_3_C,27_3_D",
  area_rdb = NA,
  tac_area_description = NA,
  comments = "Known issue: wrong species level",
  latin_name_join =  "Coregonus",
  include_in_table_2.1 = "no",
  comments_dev = NA
)

red_27 <- data.frame(
  region = NA,
  spp_name = "Sebastes",
  latin_name = "Sebastes",
  rfmo = NA,
  rfmo_stock_id = NA,
  x3a_code = NA,
  worms_aphia_id = NA,
  fides_area = NA,
  area = NA,
  area_bis = "27_1,27_2,27_5,27_12,27_14",
  area_rdb = NA,
  tac_area_description = NA,
  comments = "Known issue: wrong species level",
  latin_name_join =  "Sebastes",
  include_in_table_2.1 = "no",
  comments_dev = NA
)



linkage <- rbind(linkage, algae, capros, trachurus, coregonus, red_27)
```


# Areas

## Correct fides_area
```{r}

linkage$fides_area[linkage$latin_name == "Pleuronectes platessa" &
                     linkage$region == "North-East Atlantic" &
                     linkage$area == "8, 9, 10"] <- "8/3411"

# Removing blanks from fides_area
linkage$fides_area <- gsub(" ", "", linkage$fides_area)
```


## Check and correct area_bis


```{r}
# Removing blanks from area_bis
linkage$area_bis <- gsub(" ", "", linkage$area_bis)

# Correcting area_bis

linkage$area_bis <- gsub("12_6", "21_6", linkage$area_bis)
linkage$area_bis <- gsub("51.57", "51,57", linkage$area_bis) # Area code copied from a very old linkage file
linkage$area_bis <- gsub("81.870000000000005", "81,87", linkage$area_bis) # Area code copied from a very old linkage file
linkage$area_bis <- gsub("_21_2", "21_2", linkage$area_bis) 
linkage$area_bis <- gsub("28_7_8", "27_8", linkage$area_bis) 
linkage$area_bis <- gsub("21_3_0", "21_3_O", linkage$area_bis) 
```

```{r, include = F}
# Removing blanks from area_bis - one more time, just to be sure
linkage$area_bis <- gsub(" ", "", linkage$area_bis)

test <- unique(paste(linkage$area_bis, collapse = ","))
test_1<- arrange(distinct(as.data.frame("x" = str_split(test, ","))))
names(test_1) <- "area_bis"
test_1 <- arrange(test_1, area_bis)
```

```{r}
knitr::kable(test_1, caption = "Visual inspecion of area_bis")
```

## Check and correct area_rdb

### Notes from 2023

There is something wrong with some of the areas. A comma is missing between lists of areas, which means that not all areas were included. The error was spotted by Estonia and Latvia.

Estonia:"Table 2.1 some of our landing data is wrong, which means that total EU landing is also wrong, and it affects all MS fishing those stocks (in column J where share of EU landing is calculated). Namely FLE (49t vs 133t), TRS (12t vs 16t) and SPR (15350t vs 25858t) landings are affected. I double checked our uploaded data files -- those were correct, so something has happened in the RDB either while extracting the data or during uploading... a. Also if you compare the landings between sheets "2.1 Stocks" and "2.1 Control" then some of them do not match (i.e. EST SPR 15381t vs 15350t and HER central 11403t vs 11370t ). Differences are rather small, but there should be no differences!"

Latvia:"Values for Cod, Sprat and Flounder are not correct: it should be Cod - 35t, Sprat - 29780t and Flounder - 527t"

**I have checked with the amount after fixing area_rdb regarding missing landings - this seems to be fixed now** - except LVA cod landings where I get a mean of 854 tons

**Problems with the mean** - I have filled NA with 0 in the input data, so now the mean is correct for EST

```{r, include = F}
rdb_areas <- read.csv(paste0(path, "Area.csv"), sep = ";")
names(rdb_areas)

unique(rdb_areas$Code)

# Create a list of areas
rdb_areas <- unique(str_subset(rdb_areas$Code, "[:digit:]"))

# Coding RDB areas ----
## Start with a copy of the EUROSTAT areas - to stop the loop
linkage$area_rdb <- paste0("q", linkage$area_bis, "q")
linkage$area_rdb <- gsub(",", "q,q", linkage$area_rdb)
unique(linkage$area_rdb)

# Replace areas on upper level with all underlying areas present in the rdb code list

for (i in rdb_areas) {


  j <- paste0("q", toupper(gsub("\\.", "\\_", i)), "q")

  k <- paste0("q", i, "q")

  l <- paste0(i, ".")

  l <- gsub("\\.", "\\\\.", l)


  linkage$area_rdb <- str_replace_all(linkage$area_rdb, j, paste(i, paste(str_subset(rdb_areas, l), collapse = ","), ",", sep = ","))
}

linkage$area_rdb <- gsub("\\,,,|\\,,", "\\,", linkage$area_rdb)
linkage$area_rdb <- gsub("\\,,", "\\,", linkage$area_rdb)
linkage$area_rdb <- gsub("q", "", linkage$area_rdb)
linkage$area_rdb <- gsub(",*$", "", linkage$area_rdb) # Remove trailing comma

test <- distinct(linkage, area_bis, area_rdb)
test_2 <- unique(paste(linkage$area_rdb, collapse = ","))
test_3 <- distinct(as.data.frame("x" = str_split(test_2, ",")))
names(test_3) <- "area_rdb"
test_3 <- arrange(test_3, area_rdb)
```

```{r}
knitr::kable(test_3, caption = "Visual inspecion of area_rdb")
```

## Check and correct area_rdbes

Same procedure as for area_rdb

```{r, include = F}

rdbes_areas <- icesVocab::getCodeList("ICES_Area")
names(rdbes_areas)

rdbes_areas <- subset(rdbes_areas, Deprecated == "FALSE")

unique(rdbes_areas$Key)

# Create a list of areas
rdbes_areas <- unique(str_subset(rdbes_areas$Key, "[:digit:]"))

# Coding RDBES areas ----
## Start with a copy of the EUROSTAT areas - to stop the loop
linkage$area_rdbes <- paste0("q", linkage$area_bis, "q")
linkage$area_rdbes <- gsub(",", "q,q", linkage$area_rdbes)
unique(linkage$area_rdbes)

# linkage$area_rdbes <- paste0(",", gsub('_', '.', linkage$area_rdbes), ",") # , add to make the gsub a bit easier


# Replace areas on upper level with all underlying areas


for (i in rdbes_areas) {


  j <- paste0("q", toupper(gsub("\\.", "\\_", i)), "q")

  k <- paste0("q", i, "q")

  l <- paste0(i, ".")

  l <- gsub("\\.", "\\\\.", l)


  linkage$area_rdbes <- str_replace_all(linkage$area_rdbes, j, paste(i, paste(str_subset(rdbes_areas, l), collapse = ","), ",", sep = ","))
}

linkage$area_rdbes <- gsub("\\,,,|\\,,", "\\,", linkage$area_rdbes)
linkage$area_rdbes <- gsub("\\,,", "\\,", linkage$area_rdbes)
linkage$area_rdbes <- gsub("q", "", linkage$area_rdbes)
linkage$area_rdbes <- gsub(",*$", "", linkage$area_rdbes) # Remove trailing comma

test <- distinct(linkage, area_bis, area_rdbes)
test_2 <- unique(paste(linkage$area_rdbes, collapse = ","))
test_3 <- distinct(as.data.frame("x" = str_split(test_2, ",")))
names(test_3) <- "area_rdbes"
test_3 <- arrange(test_3, area_rdbes)

area_rdb_not_equal_area_rdbes <- distinct(subset(linkage, area_rdb != area_rdbes), area_bis, area_rdb, area_rdbes)

rdbes_areas <- icesVocab::getCodeList("ICES_Area")
area_rdbes_not_in_linkage <- distinct(subset(rdbes_areas, !(Key %in% test_3$area_rdbes)))

```

```{r}
knitr::kable(test_3, caption = "Visual inspecion of area_rdbes")

knitr::kable(area_rdbes_not_in_linkage, caption = "area_rdbes not in linkage file")
```

# Linkage

## Additions

Highlights known issues with input data. These should only be included in the control / check file, not table 2.1

I can't figure out how this will work with EUROSTAT data, so will start with creating a new check file for RDBES data

(This needs to come after the work with area, so e.g. too high area levels are not corrected by the area loops above)

```{r, eval = T}

her_28 <- data.frame(region = "Baltic Sea",
                        spp_name = "Herring",
                        latin_name = "Clupea harengus",
                        rfmo = "ICES",
                        rfmo_stock_id = NA,
                        x3a_code = "HER",
                        worms_aphia_id = 126417,
                        fides_area = NA,
                        area = NA,
                        area_bis = NA,
                        tac_area_description = NA,
                        comments = "Known issue: wrong area level",
                        latin_name_join =  "Clupea harengus",
                        area_rdb = "27.3.d.28",
                        area_rdbes = "27.3.d.28",
                        include_in_table_2.1 = "no",
                        comments_dev = NA)

ple_3a <- data.frame(region = "North Sea and Eastern Arctic",
                        spp_name = "Plaice",
                        latin_name = "Pleuronectes platessa",
                        rfmo = "ICES",
                        rfmo_stock_id = NA,
                        x3a_code = "PLE",
                        worms_aphia_id = 127143,
                        fides_area = NA,
                        area = NA,
                        area_bis = NA,
                        tac_area_description = NA,
                        comments = "Known issue: wrong area level",
                        latin_name_join =  "Pleuronectes platessa",
                        area_rdb = "27.3.a",
                        area_rdbes = "27.3.a",
                        include_in_table_2.1 = "no",
                        comments_dev = NA)


cod_3a <- data.frame(region = "North Sea and Eastern Arctic",
                        spp_name = "Cod",
                        latin_name = "Gadus morhua",
                        rfmo = "ICES",
                        rfmo_stock_id = NA,
                        x3a_code = "COD",
                        worms_aphia_id = 126436,
                        fides_area = NA,
                        area = NA,
                        area_bis = NA,
                        tac_area_description = NA,
                        comments = "Known issue: wrong area level",
                        latin_name_join =  "Gadus morhua",
                        area_rdb = "27.3.a",
                        area_rdbes = "27.3.a",
                        include_in_table_2.1 = "no",
                        comments_dev = NA)


linkage <- rbind(linkage, her_28, ple_3a, cod_3a)

```

# Species

## latin_name_join

### Remove blanks

```{r, include = F}

linkage$latin_name_join <- gsub(", ", ",", linkage$latin_name_join)

```

### Fixed outdated scientific names and aphiaid's

**TODO** - find a clever way to do this

```{r, include = F}

linkage$latin_name_join[linkage$latin_name == "Trisopterus esmarki"] <- "Trisopterus esmarki,Trisopterus esmarkii"
linkage$worms_aphia_id[linkage$latin_name == "Trisopterus esmarki"] <- "400596,126444"

linkage$latin_name_join[linkage$latin_name == "Raja alba"] <- "Raja alba,Rostroraja alba"
linkage$worms_aphia_id[linkage$latin_name == "Raja alba"] <- "217404,105896"

linkage$latin_name_join[linkage$latin_name == "Trigla lucerna"] <- "Trigla lucerna,Chelidonichthys lucerna"
linkage$worms_aphia_id[linkage$latin_name == "Trigla lucerna"] <- "154453,127262"

linkage$latin_name_join[linkage$latin_name == "Aspitrigla cuculus"] <- "Aspitrigla cuculus,Chelidonichthys cuculus"
linkage$worms_aphia_id[linkage$latin_name == "Aspitrigla cuculus"] <- "150662,127259"

```

### Group of species

```{r, include = F}

# Ammodytidae

san_worms <- subset(SpecWoRMS_with_classi, family == "Ammodytidae")[, "AphiaID"]
san_latin <-
    subset(SpecWoRMS_with_classi, family == "Ammodytidae")[, "scientificname"]

linkage$worms_aphia_id[linkage$latin_name == "Ammodytidae"] <-
    paste(san_worms, collapse = ",")
linkage$latin_name_join[linkage$latin_name == "Ammodytidae"] <-
    paste(san_latin, collapse = ",")

# Chromista

algea_worms <- subset(SpecWoRMS_with_classi, kingdom == "Chromista")[, "AphiaID"]
algea_latin <-
    subset(SpecWoRMS_with_classi, kingdom == "Chromista")[, "scientificname"]

linkage$worms_aphia_id[linkage$latin_name == "Chromista"] <-
    paste(algea_worms, collapse = ",")
linkage$latin_name_join[linkage$latin_name == "Chromista"] <-
    paste(algea_latin, collapse = ",")

# Rajidae per region and rfmo ----

fak <- as.factor(linkage$region):as.factor(linkage$rfmo)

linkage_2 <- c()

for (i in levels(fak)) {
  linkage_sub <- linkage[fak == i,]


  raj_worms <- data.frame(id = subset(SpecWoRMS_with_classi, family == "Rajidae")[, "AphiaID"])
  raj_latin <-
    data.frame(id = subset(SpecWoRMS_with_classi, family == "Rajidae")[, "scientificname"])

  worms_aphia_id_raj_there <-
    distinct(
      subset(
        linkage_sub,
        latin_name != "Rajidae" &
          worms_aphia_id %in% raj_worms$id
      ),
      worms_aphia_id
    )
  latin_name_join_raj_there <-
    distinct(
      subset(
        linkage_sub,
        latin_name != "Rajidae" &
          worms_aphia_id %in% raj_worms$id
      ),
      latin_name_join
    )

  raj_worms_2 <- 
    subset(raj_worms,
           !(id %in% worms_aphia_id_raj_there$worms_aphia_id) &
             !(id %in% c("105869", "711846")))
  
  raj_latin_2 <-
    subset(
      raj_latin,
      !(raj_latin %in% latin_name_join_raj_there$latin_name_join) &
        !(raj_latin %in% c(
          "Dipturus batis", "Dipturus intermedius"
        ))
    )

  linkage_sub$worms_aphia_id[linkage_sub$latin_name == "Rajidae"] <-
    paste(raj_worms_2$id, collapse = ",")
  linkage_sub$latin_name_join[linkage_sub$latin_name == "Rajidae"] <-
    paste(raj_latin_2$id, collapse = ",")

  linkage_2 <- rbind(linkage_2, linkage_sub)

}

```

# Output

```{r export}

write.table(linkage, paste0(path, linkage_file_name_out, ".csv"), sep = ";")

```
