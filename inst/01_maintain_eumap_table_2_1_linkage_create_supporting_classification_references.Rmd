---
title: "maintain_eumap_table_2_1_linkage_2024"
author: "Kirsten Birch Håkansson, DTU Aqua"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

library(stringr)
library(dplyr)
library(icesVocab)
library(worrms)

knitr::opts_chunk$set(echo = F)

path <- "./inst/"

linkage_file_name_in <- "eumap_table_2_1_linkage_version_2022_v2.4"
linkage_file_name_out <- "eumap_table_2_1_linkage_version_2024_v1.2"

```

```{r}
# Load linkage file

linkage <- read.csv(paste0(path, linkage_file_name_in, ".csv"), sep = ";", header = T)

names(linkage)
```

# Linkage file

```{r}
linkage$dev_comments_2024 <- NA
```

## Correction to linkage file


```{r, include = F}

# Area of area_bis 27_9_C in: North-East Atlantic	All skates and rays	Rajidae	ICES	NA	SRX 89-C.	8, 9c	27_8,27_9_C

```

## Additions to linkage file



# Areas
## Check and correct area_bis

```{r, include = F}
# Removing blanks from area_bis
linkage$area_bis <- gsub(" ", "", linkage$area_bis)

test <- unique(paste(linkage$area_bis, collapse = ","))
test_1 <- arrange(distinct(as.data.frame("x" = str_split(test, ","))))
names(test_1) <- "area_bis"
test_1 <- arrange(test_1, area_bis)

# Correcting area_bis

linkage$area_bis <- gsub("12_6", "21_6", linkage$area_bis)
linkage$area_bis <- gsub("51.57", "51,57", linkage$area_bis) # Area code copied from a very old linkage file
linkage$area_bis <- gsub("81.870000000000005", "81,87", linkage$area_bis) # Area code copied from a very old linkage file
linkage$area_bis <- gsub("_21_2", "21_2", linkage$area_bis) 
linkage$area_bis <- gsub("28_7_8", "27_8", linkage$area_bis) 
linkage$area_bis <- gsub("21_3_0", "21_3_O", linkage$area_bis) 

# Removing blanks from area_bis - one more time, just to be sure
linkage$area_bis <- gsub(" ", "", linkage$area_bis)

test <- unique(paste(linkage$area_bis, collapse = ","))
test_1<- arrange(distinct(as.data.frame("x" = str_split(test, ","))))
names(test_1) <- "area_bis"
test_1 <- arrange(test_1, area_bis)
```

```{r}
knitr::kable(test_1, caption = "Visual inspecion of area_bis")
```


## Check and correct area_rdb
### Notes from 2023
There is something wrong with some of the areas. A comma is missing between lists of areas, which means that not all areas were included. The error was spotted by Estonia and Latvia.

Estonia:"Table 2.1 some of our landing data is wrong, which means that total EU landing is also wrong, and it affects all MS fishing those stocks (in column J where share of EU landing is calculated). Namely FLE (49t vs 133t), TRS (12t vs 16t) and SPR (15350t vs 25858t) landings are affected. I double checked our uploaded data files – those were correct, so something has happened in the RDB either while extracting the data or during uploading... 
a.	Also if you compare the landings between sheets “2.1 Stocks” and “2.1 Control” then some of them do not match (i.e. EST SPR 15381t vs 15350t and HER central 11403t vs 11370t ). Differences are rather small, but there should be no differences!"

Latvia:"Values for Cod, Sprat and Flounder are not correct: it should be Cod - 35t, Sprat - 29780t and Flounder - 527t"

**I have checked with the amount after fixing area_rdb regarding missing landings - this seems to be fixed now** - except LVA cod landings where I get a mean of 854 tons

**Problems with the mean** - I have filled NA with 0 in the input data, so now the mean is correct for EST

```{r, include = F}
rdb_areas <- read.csv(paste0(path, "Area.csv"), sep = ";")
names(rdb_areas)

unique(rdb_areas$Code)

# Create a list of areas
rdb_areas <- unique(str_subset(rdb_areas$Code, "[:digit:]"))

# Coding RDB areas ----
## Start with a copy of the EUROSTAT areas - to stop the loop
linkage$area_rdb <- paste0("q", linkage$area_bis, "q")
linkage$area_rdb <- gsub(",", "q,q", linkage$area_rdb)
unique(linkage$area_rdb)

# Replace areas on upper level with all underlying areas present in the rdb code list

for (i in rdb_areas) {


  j <- paste0("q", toupper(gsub("\\.", "\\_", i)), "q")

  k <- paste0("q", i, "q")

  l <- paste0(i, ".")

  l <- gsub("\\.", "\\\\.", l)


  linkage$area_rdb <- str_replace_all(linkage$area_rdb, j, paste(i, paste(str_subset(rdb_areas, l), collapse = ","), ",", sep = ","))
}

linkage$area_rdb <- gsub("\\,,,|\\,,", "\\,", linkage$area_rdb)
linkage$area_rdb <- gsub("\\,,", "\\,", linkage$area_rdb)
linkage$area_rdb <- gsub("q", "", linkage$area_rdb)
linkage$area_rdb <- gsub(",*$", "", linkage$area_rdb) # Remove trailing comma

test <- distinct(linkage, area_bis, area_rdb)
test_2 <- unique(paste(linkage$area_rdb, collapse = ","))
test_3 <- distinct(as.data.frame("x" = str_split(test_2, ",")))
names(test_3) <- "area_rdb"
test_3 <- arrange(test_3, area_rdb)
```

```{r}
knitr::kable(test_3, caption = "Visual inspecion of area_rdb")
```

## Check and correct area_rdbes
Same procedure as for area_rdb
```{r, include = F}

rdbes_areas <- icesVocab::getCodeList("ICES_Area")
names(rdbes_areas)

rdbes_areas <- subset(rdbes_areas, Deprecated == "FALSE")

unique(rdbes_areas$Key)

# Create a list of areas
rdbes_areas <- unique(str_subset(rdbes_areas$Key, "[:digit:]"))

# Coding RDBES areas ----
## Start with a copy of the EUROSTAT areas - to stop the loop
linkage$area_rdbes <- paste0("q", linkage$area_bis, "q")
linkage$area_rdbes <- gsub(",", "q,q", linkage$area_rdbes)
unique(linkage$area_rdbes)

# linkage$area_rdbes <- paste0(",", gsub('_', '.', linkage$area_rdbes), ",") # , add to make the gsub a bit easier


# Replace areas on upper level with all underlying areas


for (i in rdbes_areas) {


  j <- paste0("q", toupper(gsub("\\.", "\\_", i)), "q")

  k <- paste0("q", i, "q")

  l <- paste0(i, ".")

  l <- gsub("\\.", "\\\\.", l)


  linkage$area_rdbes <- str_replace_all(linkage$area_rdbes, j, paste(i, paste(str_subset(rdbes_areas, l), collapse = ","), ",", sep = ","))
}

linkage$area_rdbes <- gsub("\\,,,|\\,,", "\\,", linkage$area_rdbes)
linkage$area_rdbes <- gsub("\\,,", "\\,", linkage$area_rdbes)
linkage$area_rdbes <- gsub("q", "", linkage$area_rdbes)
linkage$area_rdbes <- gsub(",*$", "", linkage$area_rdbes) # Remove trailing comma

test <- distinct(linkage, area_bis, area_rdbes)
test_2 <- unique(paste(linkage$area_rdbes, collapse = ","))
test_3 <- distinct(as.data.frame("x" = str_split(test_2, ",")))
names(test_3) <- "area_rdbes"
test_3 <- arrange(test_3, area_rdbes)

area_rdb_not_equal_area_rdbes <- distinct(subset(linkage, area_rdb != area_rdbes), area_bis, area_rdb, area_rdbes)

rdbes_areas <- icesVocab::getCodeList("ICES_Area")
area_rdbes_not_in_linkage <- distinct(subset(rdbes_areas, !(Key %in% test_3$area_rdbes)))

```

```{r}
knitr::kable(test_3, caption = "Visual inspecion of area_rdbes")

knitr::kable(area_rdbes_not_in_linkage, caption = "area_rdbes not in linkage file")
```

# Species
## latin_name_join
### Remove blanks

```{r, include = F}

linkage$latin_name_join <- gsub(", ", ",", linkage$latin_name_join)

```

### Fixed outdated scientific names and aphiaid's

**TODO** - find a clever way to do this

```{r, include = F}

linkage$latin_name_join[linkage$latin_name == "Trisopterus esmarki"] <- "Trisopterus esmarki,Trisopterus esmarkii"
linkage$worms_aphia_id[linkage$latin_name == "Trisopterus esmarki"] <- "400596,126444"

linkage$latin_name_join[linkage$latin_name == "Raja alba"] <- "Raja alba,Rostroraja alba"
linkage$worms_aphia_id[linkage$latin_name == "Raja alba"] <- "217404,105896"

linkage$latin_name_join[linkage$latin_name == "Trigla lucerna"] <- "Trigla lucerna,Chelidonichthys lucerna"
linkage$worms_aphia_id[linkage$latin_name == "Trigla lucerna"] <- "154453,127262"

linkage$latin_name_join[linkage$latin_name == "Aspitrigla cuculus"] <- "Aspitrigla cuculus,Chelidonichthys cuculus"
linkage$worms_aphia_id[linkage$latin_name == "Aspitrigla cuculus"] <- "150662,127259"



```


### Group of species 

```{r, include = F}
rdbes_spp <- icesVocab::getCodeList("SpecWoRMS")
head(rdbes_spp)

aphiaIds <- unique(rdbes_spp[!is.na(rdbes_spp$Key), "Key"])

classi <- worrms::wm_classification_(aphiaIds)

classi_1 <-
  tidyr::spread(dplyr::select(classi,-AphiaID),
                key = rank,
                value = scientificname)

# Rajidae per region and rfmo ----

fak <- as.factor(linkage$region):as.factor(linkage$rfmo)

linkage_2 <- c()

for (i in levels(fak)) {
  linkage_sub <- linkage[fak == i,]
  
  raj_worms <- subset(classi_1, Family == "Rajidae")[, "id"]
  raj_latin <-
    subset(rdbes_spp, Key %in% raj_worms$id)[, "Description"]
  
  worms_aphia_id_raj_there <-
    distinct(
      subset(
        linkage_sub,
        latin_name != "Rajidae" &
          worms_aphia_id %in% raj_worms$id
      ),
      worms_aphia_id
    )
  latin_name_join_raj_there <-
    distinct(
      subset(
        linkage_sub,
        latin_name != "Rajidae" &
          worms_aphia_id %in% raj_worms$id
      ),
      latin_name_join
    )
  
  raj_worms_2 <-
    subset(raj_worms,
           !(id %in% worms_aphia_id_raj_there$worms_aphia_id) &
             !(id %in% c("105869", "711846")))
  raj_latin_2 <-
    subset(
      raj_latin,
      !(raj_latin %in% latin_name_join_raj_there$latin_name_join) &
        !(raj_latin %in% c(
          "Dipturus batis", "Dipturus intermedius"
        ))
    )
  
  linkage_sub$worms_aphia_id[linkage_sub$latin_name == "Rajidae"] <-
    paste(raj_worms_2$id, collapse = ",")
  linkage_sub$latin_name_join[linkage_sub$latin_name == "Rajidae"] <-
    paste(raj_latin_2, collapse = ",")
  
  linkage_2 <- rbind(linkage_2, linkage_sub)
  
}

```


```{r export}

write.table(linkage_2, paste0(path, linkage_file_name_out, ".csv"), sep = ";")

```


