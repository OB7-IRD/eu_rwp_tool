---
title: "update_check_eumap_table_2_1_linkage"
author: "Kirsten Birch Håkansson, DTU Aqua"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

library(stringr)
library(dplyr)
library(icesVocab)
library(worrms)

knitr::opts_chunk$set(echo = F)

path <- "./inst/"

linkage_file_name_in <- "eumap_table_2_1_linkage_version_2022_v2.4"
linkage_file_name_out <- "eumap_table_2_1_linkage_version_2023_v1"

```

```{r}
# Load linkage file

linkage <- read.csv(paste0(path, linkage_file_name_in, ".csv"), sep = ";", header = T)

names(linkage)
```

# Areas
## area_rdb
There is something wrong with some of the areas. A comma is missing between lists of areas, which means that not all areas were included. The error was spotted by Estonia and Latvia.

Estonia:"Table 2.1 some of our landing data is wrong, which means that total EU landing is also wrong, and it affects all MS fishing those stocks (in column J where share of EU landing is calculated). Namely FLE (49t vs 133t), TRS (12t vs 16t) and SPR (15350t vs 25858t) landings are affected. I double checked our uploaded data files – those were correct, so something has happened in the RDB either while extracting the data or during uploading... 
a.	Also if you compare the landings between sheets “2.1 Stocks” and “2.1 Control” then some of them do not match (i.e. EST SPR 15381t vs 15350t and HER central 11403t vs 11370t ). Differences are rather small, but there should be no differences!"

Latvia:"Values for Cod, Sprat and Flounder are not correct: it should be Cod - 35t, Sprat - 29780t and Flounder - 527t"

**I have checked with the amount after fixing area_rdb regarding missing landings - this seems to be fixed now** - except LVA cod landings where I get a mean of 854 tons

**Problems with the mean** - I have filled NA with 0 in the input data, so now the mean is correct for EST

```{r}
rdb_areas <- read.csv(paste0(path, "Area.csv"), sep = ";")
names(rdb_areas)

unique(rdb_areas$Code)

# Create a list of areas
rdb_areas <- unique(str_subset(rdb_areas$Code, "[:digit:]"))

# Removing blanks from areaBis

unique(linkage$area_bis)

linkage$area_bis <- gsub(" ", "", linkage$area_bis)


# Coding RDB areas ----
## Start with a copy of the EUROSTAT areas - to stop the loop
linkage$area_rdb <- paste0("q", linkage$area_bis, "q")
linkage$area_rdb <- gsub(",", "q,q", linkage$area_rdb)
unique(linkage$area_rdb)

# linkage$area_rdb <- paste0(",", gsub('_', '.', linkage$area_rdb), ",") # , add to make the gsub a bit easier


# Replace areas on upper level with all underlying areas


for (i in rdb_areas) {


  j <- paste0("q", toupper(gsub("\\.", "\\_", i)), "q")

  k <- paste0("q", i, "q")

  l <- paste0(i, ".")

  l <- gsub("\\.", "\\\\.", l)


  linkage$area_rdb <- str_replace_all(linkage$area_rdb, j, paste(i, paste(str_subset(rdb_areas, l), collapse = ","), ",", sep = ","))
}

linkage$area_rdb <- gsub("\\,,,|\\,,", "\\,", linkage$area_rdb)
linkage$area_rdb <- gsub("q", "", linkage$area_rdb)
linkage$area_rdb <- gsub(",*$", "", linkage$area_rdb) # Remove trailing comma

test <- distinct(linkage, area_bis, area_rdb)
test_2 <- unique(paste(linkage$area_rdb, collapse = ","))
test_3 <- distinct(as.data.frame("x" = str_split(test_2, ",")))
```

## area_rdbes
Same procedure as for area_rdb
```{r}

rdbes_areas <- icesVocab::getCodeList("ICES_Area")
names(rdbes_areas)

unique(rdbes_areas$Key)

# Create a list of areas
rdbes_areas <- unique(str_subset(rdbes_areas$Key, "[:digit:]"))

# Removing blanks from areaBis

unique(linkage$area_bis)

linkage$area_bis <- gsub(" ", "", linkage$area_bis)


# Coding RDBES areas ----
## Start with a copy of the EUROSTAT areas - to stop the loop
linkage$area_rdbes <- paste0("q", linkage$area_bis, "q")
linkage$area_rdbes <- gsub(",", "q,q", linkage$area_rdbes)
unique(linkage$area_rdbes)

# linkage$area_rdbes <- paste0(",", gsub('_', '.', linkage$area_rdbes), ",") # , add to make the gsub a bit easier


# Replace areas on upper level with all underlying areas


for (i in rdb_areas) {


  j <- paste0("q", toupper(gsub("\\.", "\\_", i)), "q")

  k <- paste0("q", i, "q")

  l <- paste0(i, ".")

  l <- gsub("\\.", "\\\\.", l)


  linkage$area_rdbes <- str_replace_all(linkage$area_rdbes, j, paste(i, paste(str_subset(rdb_areas, l), collapse = ","), ",", sep = ","))
}

linkage$area_rdbes <- gsub("\\,,,|\\,,", "\\,", linkage$area_rdbes)
linkage$area_rdbes <- gsub("q", "", linkage$area_rdbes)
linkage$area_rdbes <- gsub(",*$", "", linkage$area_rdbes) # Remove trailing comma

test <- distinct(linkage, area_bis, area_rdbes)
test_2 <- unique(paste(linkage$area_rdbes, collapse = ","))
test_3 <- distinct(as.data.frame("x" = str_split(test_2, ",")))

area_rdb_not_equal_area_rdbes <- distinct(subset(linkage, area_rdb != area_rdbes), area_bis, area_rdb, area_rdbes)

```


# Species
## latin_name_join
### Remove blanks

```{r}

linkage$latin_name_join <- gsub(", ", ",", linkage$latin_name_join)

```

### Group of species 

```{r}
rdbes_spp <- icesVocab::getCodeList("SpecWoRMS")
head(rdbes_spp)

aphiaIds <- unique(rdbes_spp[!is.na(rdbes_spp$Key), "Key"])

classi <- worrms::wm_classification_(aphiaIds)

classi_1 <-
  tidyr::spread(dplyr::select(classi,-AphiaID),
                key = rank,
                value = scientificname)

# Rajidae per region and rfmo ----

fak <- as.factor(linkage$region):as.factor(linkage$rfmo)

linkage_2 <- c()

for (i in levels(fak)) {
  linkage_sub <- linkage[fak == i,]
  
  
  raj_worms <- subset(classi_1, Family == "Rajidae")[, "id"]
  raj_latin <-
    subset(rdbes_spp, Key %in% raj_worms$id)[, "Description"]
  
  worms_aphia_id_raj_there <-
    distinct(
      subset(
        linkage_sub,
        latin_name != "Rajidae" &
          worms_aphia_id %in% raj_worms$id
      ),
      worms_aphia_id
    )
  latin_name_join_raj_there <-
    distinct(
      subset(
        linkage_sub,
        latin_name != "Rajidae" &
          worms_aphia_id %in% raj_worms$id
      ),
      latin_name_join
    )
  
  raj_worms_2 <-
    subset(raj_worms,
           !(id %in% worms_aphia_id_raj_there$worms_aphia_id) &
             !(id %in% c("105869", "711846")))
  raj_latin_2 <-
    subset(
      raj_latin,
      !(raj_latin %in% latin_name_join_raj_there$latin_name_join) &
        !(raj_latin %in% c(
          "Dipturus batis", "Dipturus intermedius"
        ))
    )
  
  linkage_sub$worms_aphia_id[linkage_sub$latin_name == "Rajidae"] <-
    paste(raj_worms_2$id, collapse = ",")
  linkage_sub$latin_name_join[linkage_sub$latin_name == "Rajidae"] <-
    paste(raj_latin_2, collapse = ",")
  
  linkage_2 <- rbind(linkage_2, linkage_sub)
  
}

```


```{r export}

write.table(linkage_2, paste0(path, linkage_file_name_out, ".csv"), sep = ";")

```


